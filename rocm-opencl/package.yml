name       : rocm-opencl
version    : 5.1.0
release    : 1
source     :
    - https://github.com/ROCm-Developer-Tools/ROCclr/archive/refs/tags/rocm-5.1.0.tar.gz : f4f265604b534795a275af902b2c814f416434d9c9e16db81b3ed5d062187dfa
    - https://github.com/RadeonOpenCompute/ROCm-OpenCL-Runtime/archive/refs/tags/rocm-5.1.0.tar.gz : 362d81303048cf7ed5d2f69fb65ed65425bc3da4734fff83e3b8fbdda51b0927
license    : MIT
component  : programming.devel
summary    : OpenCL 2.2 compatible language runtime
description: |
    OpenCL 2.2 compatible language runtime
extract    : False
builddeps  :
    - libx11-devel
    - pkgconfig(d3d)
    - pkgconfig(OpenCL)
    - pkgconfig(gl)
    - hsakmt-devel
    - rocm-cmake
    - rocm-runtime-devel
    - rocm-compilersupport
    - rocm-device-libs-devel
setup      : |
    #mkdir temp
    ls -ltra $sources
    #tar -xvzf $sources/rocm-5.1.0.tar.gz.1 -C temp --strip-components=1
    #cp -r temp/khronos/headers/opencl2.2 .
    #rm -rf temp
    #tar -xvzf $sources/rocm-5.1.0.tar.gz -C . --strip-components=1
    tar -xvzf $sources/rocm-5.1.0.tar.gz
    tar -xvzf $sources/rocm-5.1.0.tar.gz.1
    ls -ltra
    cd ROCclr-rocm-%version%
    ls -ltra
    %cmake -Wno-dev -B build-rocclr -DAMD_OPENCL_PATH="%workdir%/ROCm-OpenCL-Runtime-rocm-%version%"
    %make -C build-rocclr
    cd ..
    cd %workdir%/ROCm-OpenCL-Runtime-rocm-%version%
    %apply_patches
    %cmake -Wno-dev -B build  \
    -DCMAKE_BUILD_TYPE=Release \
    -DROCM_PATH=%PREFIX% \
    -DCMAKE_PREFIX_PATH="%workdir%/ROCclr-rocm-%version%;%prefix%" \
    -DAMD_OPENCL_PATH="%workdir%/ROCm-OpenCL-Runtime-rocm-%version%" -DBUILD_ICD=OFF
    #cmake -DROCM_PATH=%prefix% -DAMD_OPENCL_PATH=%workdir% -DBUILD_ICD=OFF -DCMAKE_BUILD_TYPE=RelWithDebInfo
build      : |
    cd %workdir%/ROCm-OpenCL-Runtime-rocm-%version%
    %make -C build
install    : |
    cd %workdir%/ROCm-OpenCL-Runtime-rocm-%version%
    %make_install -C build

    install -D -m 644 config/amdocl64.icd \
    %installroot%/etc/OpenCL/vendors/amdocl64.icd

    #Avoid file conflicts with opencl-headers package:
    mkdir -p %installroot%/usr/include/rocm-opencl
    mv %installroot%/usr/include/CL %installroot%/usr/include/rocm-opencl/CL

    #Avoid file conflicts with clinfo package:
    mv %installroot%/usr/bin/clinfo %installroot%/usr/bin/rocm-clinfo
