name       : rocm
version    : 5.1.0
release    : 1
source     :
    - https://github.com/ROCm-Developer-Tools/ROCclr/archive/refs/tags/rocm-5.1.0.tar.gz#ROCclr.tar.gz : f4f265604b534795a275af902b2c814f416434d9c9e16db81b3ed5d062187dfa
    - https://github.com/RadeonOpenCompute/ROCm-OpenCL-Runtime/archive/refs/tags/rocm-5.1.0.tar.gz#ROCm-OpenCL-Runtime.tar.gz : 362d81303048cf7ed5d2f69fb65ed65425bc3da4734fff83e3b8fbdda51b0927
license    : MIT
component  : programming.devel
clang      : yes
summary    :
    - OpenCL 2.2 compatible language runtime for AMD Radeon GPUs
    - rocm-rocclr : Radeon Open Compute Common Language Runtime
    - rocm-rocclr-devel : ROCclr development package
description: |
    OpenCL 2.2 compatible language runtime for AMD Radeon GPUs
extract    : False
rundeps    :
    - opencl :
        - rocm-rocclr
        - rocminfo
    - opencl-devel :
        - rocm-rocclr-devel
        - rocm-opencl
    - rocclr-devel:
        - rocm-rocclr
patterns   :
    - opencl :
        - /usr/bin/rocm-clinfo
        - /usr/share/OpenCL
        - /usr/share/doc
        - /usr/lib64/*
    - opencl-devel :
        - /usr/include/rocm-opencl
    - rocclr :
        - /usr/lib64/librocclr.so.5*
    - rocclr-devel :
        - /usr/lib64/librocclr.so
        - /usr/include/rocclr
        - /usr/share/cmake
builddeps  :
    - pkgconfig(OpenCL)
    - pkgconfig(d3d)
    - pkgconfig(gl)
    - pkgconfig(libhsakmt)
    - pkgconfig(x11-xcb)
    - rocm-cmake
    - rocm-compilersupport-devel
    - rocm-device-libs-devel
    - rocm-runtime-devel
setup      : |
    tar -xvzf $sources/ROCclr.tar.gz
    tar -xvzf $sources/ROCm-OpenCL-Runtime.tar.gz
    pushd ROCclr-rocm-%version%
    %patch -p1 < $pkgfiles/0001-enable-gfx800.patch
    %patch -p1 < $pkgfiles/0001-Allow-ROCclr-to-be-built-standalone.patch
    sed -i "s/STATIC/SHARED/" cmake/ROCclr.cmake
    echo "set_target_properties(rocclr PROPERTIES VERSION 5.1.0 SOVERSION 5.1)" \
    >> cmake/ROCclr.cmake
    %cmake -Wno-dev \
        -DAMD_OPENCL_PATH="%workdir%/ROCm-OpenCL-Runtime-rocm-%version%"
    popd
    pushd ROCm-OpenCL-Runtime-rocm-%version%
    ls -d khronos/icd/* | grep -v loader | xargs rm -r
    ls -d khronos/icd/loader/* | grep -v icd_dispatch.h | xargs rm -r
    ls -d khronos/headers/* | grep -v opencl2.2 | xargs rm -r
    rm -r khronos/headers/*/tests/
    %apply_patches
    %cmake -Wno-dev  \
        -DCMAKE_MODULE_PATH="%workdir%/ROCclr-rocm-%version%" \
        -DROCM_PATH=%PREFIX% \
        -DROCCLR_PATH="%workdir%/ROCclr-rocm-%version%" \
        -DAMD_OPENCL_PATH="%workdir%/ROCm-OpenCL-Runtime-rocm-%version%" -DBUILD_ICD=OFF
build      : |
    pushd ROCclr-rocm-%version%
    %make
    popd
    pushd ROCm-OpenCL-Runtime-rocm-%version%
    %make
install    : |
    pushd ROCclr-rocm-%version%
    %make_install

    popd
    pushd ROCm-OpenCL-Runtime-rocm-%version%
    %make_install

    install -Dm00644 config/amdocl64.icd \
    %installroot%/usr/share/OpenCL/vendors/amdocl64.icd

    #Avoid file conflicts with opencl-headers package:
    mkdir -p %installroot%/usr/include/rocm-opencl
    mv %installroot%/usr/include/CL %installroot%/usr/include/rocm-opencl/CL

    #CMake excludes installing this for some reason
    install -Dm00644 khronos/headers/opencl2.2/CL/cl_egl.h \
        %installroot%/usr/include/rocm-opencl/CL

    #Install bundled khronos icd header that hip needs:
    install -Dm00644 khronos/icd/loader/icd_dispatch.h \
        %installroot%/usr/include/rocm-opencl/icd/loader/icd_dispatch.h

    #Avoid file conflicts with clinfo package:
    mv %installroot%/usr/bin/clinfo %installroot%/usr/bin/rocm-clinfo
